{% extends "base_template.html" %}
{% load static %}
{% block title %}User Management{% endblock %}
{% block style %}
    <link rel="stylesheet" href="{% static "/css/generate_invitation.css" %}">
    <style>
        .container {
            margin: 30px;
        }

        .empty-text p {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }

        .input-field {
            margin-bottom: 15px;
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .generate-invitation-form {
            display: grid;
            width: 100%;
            gap: 32px;
            grid-template-columns: 1fr 1fr;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-checkboxes {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-checkboxes > div {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .lifetime-field {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 5px;
        }

        .lifetime-field label {
            display: block;
            text-align: left;
            width: 100%;
            margin-bottom: 2px;
            font-size: 14px;
        }


        /* #invitation-link-modal div {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            position: relative;
        }

        #edit-user-modal div {
            background: #333333;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            position: relative;
        }

        #invitation-link-modal h3 {
            color: black;
        }

        #edit-user-modal h3 {
            color: white;
        } */

        /* .modal-input-field {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-bottom: 0;
        } */

        #id_remove_quota, #id_remove_lifetime {
            margin-bottom: 0;
        }


        /* .modal-input-field input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
        }


        .wrapper .modal-input-field {
            color: #fff;
            position: relative;
            margin-bottom: 4px;
        }

        .modal-input-field label {
            font-size: 14px;
            color: white;
            padding: 0;
            margin: 0;
            pointer-events: auto;
            white-space: nowrap;
        }

        .modal-input-field i {
            position: absolute;
            right: 20px;
            top: 50%;
            color: var(--tom-light-gray);
            transform: translateY(-50%);
            font-size: 20px;
        }

        .modal-input-field input {
            border-radius: 10px;
            padding: 6px;
            width: 100%;
            border: none;
            color: black;
            font-size: 14px;
        }

        .modal p {
            color: black;
            word-wrap: break-word;
            margin-bottom: 20px;
        }

        .modal .form-group {
            margin-bottom: 10px;
        }

        .modal .submit-button {
            margin-top: 10px;
        } */


        table {
            margin: 20px 0;
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            box-sizing: border-box;
        }

        .table-row {
            border-top: 1px solid var(--medium);
        }

        .table-row-highlight {
            background-color: var(--medium-dark);
        }

        table th, td {
            padding: 8px;
        }

        .styled-select {
            background-color: #333333;
            color: #ffffff;
            padding: 5px 10px;
            border-radius: 5px;
            border: none;
            width: 100%;
        }

        .styled-select:focus {
            outline: none;
            box-shadow: 0 0 5px #888;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="container">
        <div class="content-wrapper content-container">
            <!-- Invitation Form -->
            <p class="heading">Generate Invitation</p>
            {% if error is not None %}<p class="error">{{ error }}</p>{% endif %}
            <form id="invitationForm">
                {% csrf_token %}
                <div class="generate-invitation-form">
                    <div>
                        <div class="input-field">{{ invitation_form.email }}</div>
                        <div class="input-field">{{ invitation_form.username }}</div>
                    </div>
                    <div>
                        <div class="input-field">
                            <label for="id_role_selector"></label>
                            <select name="role"
                                    id="id_role_selector"
                                    class="styled-select"
                                    onchange="checkRoleChange">
                                {% for value, label in invitation_form.role.field.choices %}
                                    <option value="{{ value }}"
                                            {% if invitation_form.role.value == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-field">
                                <input type="checkbox"
                                       id="id_expert"
                                       name="expert"
                                       {% if invitation_form.expert.value %}checked{% endif %}>
                                <label for="id_expert">Expert</label>
                            </div>
                            <div class="checkbox-field">
                                <input type="checkbox" id="enableQuota" onclick="toggleInput('quotaField')">
                                <label for="enableQuota">Max. Simultaneous Requests</label>
                            </div>
                            <div class="input-field" id="quotaField" style="display: none;">{{ invitation_form.quota }}</div>
                            <div class="checkbox-field">
                                <input type="checkbox"
                                       id="enableLifetime"
                                       onclick="toggleInput('lifetimeField')">
                                <label for="enableLifetime">Limited Usage Time</label>
                            </div>
                            <div class="input-field" id="lifetimeField" style="display: none;">{{ invitation_form.lifetime }}</div>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn" onclick="createInvitation()">Generate</button>
                        </div>
                    </div>
                </div>
            </form>
            <!-- Open Invitations -->
            <div>
                <p class="heading">Open Invitations</p>
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Alias</th>
                            <th>Role</th>
                            <th>Quota</th>
                            <th>Lifetime</th>
                            <th>Invitation Link</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if invitations %}
                            {% for invitation in invitations %}
                                <tr>
                                    <td>{{ invitation.email }}</td>
                                    {% if invitation.username != invitation.email %}
                                        <td>{{ invitation.username }}</td>
                                    {% else %}
                                        <td></td>
                                    {% endif %}
                                    <td>{{ invitation.role }}</td>
                                    <td>{{ invitation.quota }}</td>
                                    <td>{{ invitation.lifetime }}</td>
                                    <td>{{ invitation.link }}</td>
                                    <td>
                                        {% if invitation.link != "" %}
                                            <button id="copy-invitation-action-{{ invitation.id }}"
                                                    type="button"
                                                    class="icon-btn"
                                                    onclick="copyLinkToClipboard('{{ invitation.link }}', document.getElementById('copy-invitation-action-{{ invitation.id }}'))">
                                                <i class="bx bx-copy"></i>
                                            </button>
                                        {% endif %}
                                        <form id="delete-invitation-{{ invitation.id }}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="button"
                                                    class="icon-btn"
                                                    onclick="deleteInvitation({{ invitation.id }})">
                                                <i class="bx bx-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7">No open invitations found.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <!-- All Users -->
            <div>
                <p class="heading">All Users</p>
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Alias</th>
                            <th>Role</th>
                            <th>Quota</th>
                            <th>Lifetime</th>
                            <th>Date Joined</th>
                            {% if perms.accounts.can_delete_users %}<th>Actions</th>{% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for target_user in users %}
                            {% if target_user.deletion_pending == False %}
                                <tr id="user-{{ target_user.id }}"
                                    class="table-row {% if target_user.id == current_user.id %}table-row-highlight{% endif %}">
                                    <td>{{ target_user.email }}</td>
                                    {% if target_user.username != target_user.email %}
                                        <td>{{ target_user.username }}</td>
                                    {% else %}
                                        <td></td>
                                    {% endif %}
                                    <td>{{ target_user.get_role }}</td>
                                    <td>{{ target_user.quota }}</td>
                                    <td>{{ target_user.lifetime }}</td>
                                    <td>{{ target_user.date_joined }}</td>
                                    <td>
                                        {% if perms.accounts.can_edit_users %}
                                            <form id="edit-user-{{ target_user.id }}" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="button"
                                                        class="icon-btn"
                                                        onclick="editUser({ id: {{ target_user.id }}, email: '{{ target_user.email }}', username: '{{ target_user.username }}', quota : '{{ target_user.quota }}', lifetime : '{{ target_user.lifetime }}' })">
                                                    <i class="bx bx-edit"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                        {% if perms.accounts.can_delete_users %}
                                            <form id="delete-user-{{ target_user.id }}" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="button"
                                                        class="icon-btn"
                                                        onclick="deleteUser({{ target_user.id }})">
                                                    <i class="bx bx-trash"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="edit-user-modal" class="modal">
        <div class="content-wrapper">
            <h3 id="edit_modal_title">Edit User</h3>
            <form id="editUserForm">
                {% csrf_token %}
                <div class="form-group">
                    <div class="modal-input-field">{{ edit_user_form.new_email }}</div>
                    <div class="modal-input-field">{{ edit_user_form.new_alias }}</div>
                    <div class="modal-checkboxes">
                        <div id="id_remove_quota">
                            <input type="checkbox"
                                   id="remove_quota"
                                   name="remove_quota"
                                   onclick="toggleInput('new-quota-field')">
                            <label for="remove_quota">Remove Quota</label>
                        </div>
                        <div id="id_remove_lifetime">
                            <input type="checkbox"
                                   id="remove_lifetime"
                                   name="remove_lifetime"
                                   onclick="toggleInput('new-lifetime-field')">
                            <label for="remove_lifetime">Remove Lifetime</label>
                        </div>
                    </div>
                    <div class="modal-input-field" id="new-quota-field">{{ edit_user_form.new_quota }}</div>
                    <div class="modal-input-field lifetime-field" id="new-lifetime-field">
                        <label for="id_new_lifetime">New Lifetime</label>
                        {{ edit_user_form.new_lifetime }}
                    </div>
                </div>
                <input type="hidden" id="edit-user-id" name="user_id">
                <button type="button" class="green-button" onclick=submitEditUser()>Save Changes</button>
                <button type="button" onclick="closeModal()">Close</button>
            </form>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        function checkRoleChange() {
            const role = document.getElementById('id_role_selector').value;
            const expertCheckbox = document.getElementById('id_expert');

            if (role === '{{ UserGroups.ADMIN }}') {
                expertCheckbox.checked = true;
                expertCheckbox.disabled = true;
            } else {
                expertCheckbox.disabled = false;
                expertCheckbox.checked = false;
            }
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const focusedElement = document.activeElement;

                if (focusedElement.tagName === 'INPUT' && focusedElement.type === 'text') {
                    createInvitation();
                }
            }
        });

        function toggleInput(fieldId) {
            const field = document.getElementById(fieldId);
            field.style.display = field.style.display === 'none' ? 'block' : 'none';
        }

        async function createInvitation() {
            const form = document.getElementById('invitationForm');
            const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
            const email = form.querySelector('input[name="email"]').value;

            const formData = new FormData(form);

            if (document.getElementById('quotaField').style.display === 'none') {
                formData.delete('quota');
            }
            if (document.getElementById('lifetimeField').style.display === 'none') {
                formData.delete('lifetime');
            }

            try {
                const response = await fetch("{%  url 'has-invitation' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                    }),
                });
                let data = await response.json();
                if (data['has_invitation'] === true) {
                    if (!await showConfirmModal("Override Invitation", `An invitation already exists for this email. Do you want to override the invitation?`, "Override")) {
                        return;
                    }
                }
                const generateResponse = await fetch("{% url 'generate-user-invitation' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                    },
                    body: formData,
                });
                let linkData = await generateResponse.json();
                if (generateResponse.ok) {
                  const link = linkData['link'];
                    if (await showConfirmModal("Invitation created", "Invitation Link:\n" + link, "Copy link")) {
                        copyLinkToClipboard(link, null);
                    }
                } else {
                    if (linkData['error']) {
                      await showModal("Failed to create invitation", `Got an error for email "${email}".\n${linkData['error']}`);
                    } else {
                        await showModal("Failed to create invitation", "An unknown error occurred. Please try again.");
                    }
                }
            } catch (error) {
                await showModal("Failed to create invitation", "An unknown error occurred. Please try again.");
            }
        }

        function copyLinkToClipboard(link, element) {
          navigator.clipboard.writeText(link);
          //TODO: Restore ability to show some kind of signal to the user that it was copied
        }

        function closeModal() {
            document.getElementById('edit-user-modal').style.display = 'none';

            // Clear form inputs
            const invitationForm = document.getElementById('invitationForm');
            invitationForm.reset();
            const editUserForm = document.getElementById('editUserForm');
            editUserForm.reset();
            const newQuotaField = document.getElementById('new-quota-field');
            newQuotaField.style.content = 'none';
            const newLifetimeField = document.getElementById('new-lifetime-field');
            newLifetimeField.style.content = 'none';
            const removeQuota = document.getElementById('id_remove_quota');
            removeQuota.style.content = 'none';
            const removeLifetime = document.getElementById('id_remove_lifetime');
            removeLifetime.style.content = 'none';
            location.reload();
        }

        async function deleteUser(userId) {
            if (!await showConfirmModal("Delete account", "Are you sure you want to mark this user for deletion?"), "Delete") {
                return;
            }

            const form = document.getElementById(`delete-user-${userId}`);
            const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

            try {
                const response = await fetch("{% url 'delete-user' 0 %}".replace("0", userId), {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();

                if (response.ok) {
                    await showModal("User Deleted", data.message || "User was successfully marked for deletion.");
                    form.closest('tr').remove(); // Remove the row from the table
                } else {
                    await showModal("Error occurred", data.error || "An error occurred while marking the user for deletion.");
                }
            } catch (error) {
                await showModal("Error occurred", "An unknown error occurred while marking the user for deletion. Please try again.");
            }
        }

        function editUser(user) {
            const id = user.id;
            const email = user.email;
            const username = user.username;
            const currentQuota = user.quota;
            const currentLifetime = user.lifetime;

            document.getElementById('edit_modal_title').value = email;

            if (currentQuota === "None") {
                document.getElementById('id_remove_quota').style.display = 'none';
            } else {
                document.getElementById('id_remove_quota').style.display = 'block';
            }

            if (currentLifetime === "None") {
                document.getElementById('id_remove_lifetime').style.display = 'none';
            } else {
                document.getElementById('id_remove_lifetime').style.display = 'block';
            }

            document.getElementById('edit-user-id').value = id;
            document.getElementById('edit-user-modal').style.display = 'flex';
            let title;
            if (username !== email) {
                title = `Edit user ${username} (${email})`;
            } else {
                title = `Edit user ${email}`;
            }
            document.getElementById('edit_modal_title').textContent = title;
            const modalContent = document.querySelector('#edit-user-modal > div');
            modalContent.style.display = 'flex';
            modalContent.style.flexDirection = 'column';
            modalContent.style.alignItems = 'center';
        }

        async function submitEditUser() {
            const form = document.getElementById('editUserForm');
            const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
            const formData = new FormData(form);
            if (document.getElementById('new-quota-field').style.display === 'none') {
                formData.delete('new_quota');
            }

            if (document.getElementById('new-lifetime-field').style.display === 'none') {
                formData.delete('new_lifetime');
            }

            if (document.getElementById('id_remove_quota').style.display === 'none') {
                formData.delete('remove_quota');
            }

            if (document.getElementById('id_remove_lifetime').style.display === 'none') {
                formData.delete('remove_lifetime');
            }

            try {
                const response = await fetch("{% url 'edit-user' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                    },
                    body: formData,
                });


                if (response.ok) {
                    closeModal();
                    location.reload();
                } else {
                    await showModal("Updating user failed", "An unknown error occurred while updating the user. Please try again.");
                }
            } catch (error) {
                await showModal("Updating user failed", "An unknown error occurred while updating the user. Please try again.");
            }
        }


        async function deleteInvitation(invitationId) {
            const form = document.getElementById(`delete-invitation-${invitationId}`);
            const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
            console.log("Invitation ID: ", invitationId);
            try {
                const response = await fetch("{% url 'delete-invitation' 0 %}".replace("0", invitationId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();

                if (response.ok) {
                    await showModal("Deleted Invitation", data.message || "Invitation deleted successfully!");
                    location.reload();
                } else {
                    await showModal("Failed to delete Invitation", data.error || "An error occurred while deleting the invitation.");
                }
            } catch (error) {
                await showModal("Failed to delete Invitation", "An unknown error occurred while deleting the invitation.");
            }
        }
    </script>
{% endblock %}
